import os
import json
import google.generativeai as genai
from dotenv import load_dotenv

# 1. å®‰å…¨è¼‰å…¥é‡‘é‘°
load_dotenv()
api_key = os.getenv("GEMINI_API_KEY")

if not api_key:
    print("åš´é‡éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° API é‡‘é‘°ã€‚è«‹ç¢ºèª .env æª”æ¡ˆæ˜¯å¦å­˜åœ¨ä¸”è¨­å®šæ­£ç¢ºã€‚")
    exit()

# 2. åˆå§‹åŒ– Gemini ç³»çµ±å¤§è…¦
genai.configure(api_key=api_key)
# ä½¿ç”¨ Flash æ¨¡å‹ï¼Œé€Ÿåº¦å¿«ä¸”é©åˆè™•ç†æ–‡æœ¬ä»»å‹™
model = genai.GenerativeModel('gemini-2.5-flash')

# 3. è®€å–ä½ çš„æœ¬æ©Ÿè³‡æ–™åº«
try:
    with open('competitor_data.json', 'r', encoding='utf-8') as f:
        database = json.load(f)
except FileNotFoundError:
    print("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° competitor_data.jsonã€‚è«‹å…ˆç¢ºèªçˆ¬èŸ²ç¨‹å¼å·²æˆåŠŸåŸ·è¡Œã€‚")
    exit()

# 4. æ¨¡æ“¬è¡ŒéŠ·åŒäº‹è¼¸å…¥çš„ã€ŒåŸå§‹è‰ç¨¿ã€
draft_copy = """
åŠå°é«”ç”¢æ¥­è¿‘å¹´ç™¼å±•è¿…é€Ÿï¼Œè¨±å¤šå…¬å¸éƒ½åœ¨ç©æ¥µä½ˆå±€ã€‚
æˆ‘å€‘ SEMI Taiwan è‡´åŠ›æ–¼æ¨å‹•ç”¢æ¥­éˆçš„ç™¼å±•ï¼Œå¸Œæœ›èƒ½æ¶ä½”å¸‚å ´å…ˆæ©Ÿï¼Œ
ä¸¦å¹«åŠ©åœ¨åœ°ä¼æ¥­èˆ‡åœ‹éš›æ¥è»Œã€‚
"""

# 5. è³‡æ–™è™•ç†ï¼šå°‡ç«¶çˆ­å°æ‰‹çš„çµæ§‹è½‰åŒ–ç‚º AI çœ‹å¾—æ‡‚çš„ Prompt
competitor_structures = ""
for idx, data in enumerate(database):
    competitor_structures += f"\nã€ç«¶çˆ­å°æ‰‹ {idx+1}ã€‘({data['h1_title']}):\n"
    # å°‡æ‰€æœ‰ H2 æ¨™é¡Œç”¨é€—è™Ÿä¸²æ¥èµ·ä¾†
    competitor_structures += ", ".join(data['h2_subheadings']) + "\n"

# 6. æ ¸å¿ƒç”¢å“é‚è¼¯ï¼šå»ºæ§‹ç³»çµ±æç¤ºè© (System Prompt)
prompt = f"""
ä½ ç¾åœ¨æ˜¯ä¸€ä½é ‚ç´šçš„ç§‘æŠ€æ¥­ SEO/AIEO è¡ŒéŠ·ç¸½ç›£ã€‚
æˆ‘æœ‰ä¸€æ®µåŒäº‹å¯«çš„åˆç‰ˆè¡ŒéŠ·è‰ç¨¿ï¼Œä»¥åŠæˆ‘å€‘å‰›å¾å¸‚å ´ä¸Šçˆ¬å–ä¸‹ä¾†çš„ä¸‰ç¯‡é«˜æ’åç«¶çˆ­å°æ‰‹æ–‡ç« çš„æ¨™é¡Œæ¶æ§‹ï¼ˆH2ï¼‰ã€‚

ã€å¸‚å ´ç«¶çˆ­å°æ‰‹æ¶æ§‹æ•¸æ“šã€‘ï¼š
{competitor_structures}

ã€åŒäº‹çš„åŸå§‹è‰ç¨¿ã€‘ï¼š
{draft_copy}

ã€ä½ çš„ä»»å‹™ã€‘ï¼š
1. ç—›é»åˆ†æï¼šè«‹å†·é…·ä¸”å°ˆæ¥­åœ°åˆ†æï¼Œæˆ‘å€‘çš„è‰ç¨¿å°æ¯”ç«¶çˆ­å°æ‰‹çš„æ¶æ§‹ï¼Œæ¼æ‰äº†å“ªäº›é—œéµçš„ç”¢æ¥­ç¶­åº¦ï¼ˆä¾‹å¦‚ï¼šç‰©ç†ç‰¹æ€§ã€è£½ç¨‹æŠ€è¡“ã€æ­·å²ç™¼å±•ç­‰ï¼‰ã€‚
2. é‡ç£…æ”¹å¯«ï¼šè«‹ç›´æ¥æ ¹æ“šé€™äº›å°æ‰‹çš„å„ªå‹¢æ•¸æ“šï¼Œå°‡æˆ‘å€‘çš„è‰ç¨¿æ”¹å¯«æˆä¸€ç¯‡çµæ§‹æ›´å…·æ¬Šå¨æ€§ã€ç¬¦åˆæœå°‹å¼•æ“å–œå¥½çš„é«˜éšè¡ŒéŠ·æ–‡æ¡ˆã€‚
"""

print("ç³»çµ±é€£ç·šä¸­ï¼šæ­£åœ¨å°‡å¸‚å ´æ•¸æ“šèˆ‡è‰ç¨¿å‚³é€çµ¦ Gemini AI å¤§è…¦åˆ†æ...\n")

# 7. åŸ·è¡Œç”Ÿæˆä¸¦è¼¸å‡ºçµæœ
try:
    response = model.generate_content(prompt)
    print("========== ğŸš€ AI æ·±åº¦åˆ†æèˆ‡æ–‡æ¡ˆå„ªåŒ–çµæœ ==========\n")
    print(response.text)
    print("\n==================================================")
except Exception as e:
    print(f"å‘¼å« API ç™¼ç”Ÿç•°å¸¸ï¼š{e}")